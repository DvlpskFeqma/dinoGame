<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>純HTML小恐龍遊戲</title>
    <style>
        body { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 1s ease;
            overflow: hidden; /* 防止震動時出現捲軸 */
        }
        h1, p { 
            color: #555; 
            transition: color 1s ease;
        }
        canvas { 
            border: 2px solid #333;
            transition: border-color 1s ease;
            display: block; /* 解決canvas底部多餘的空間 */
        }
        #canvas-container.shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>

    <h1>小恐龍遊戲</h1>
    <div id="canvas-container">
        <canvas id="gameCanvas" width="800" height="250"></canvas>
    </div>
    <p><strong>Z/C</strong>移動 | <strong>空白鍵</strong>跳躍 | <strong>X</strong>發射 (集滿可蓄力)</p>

    <script>
        const canvasContainer = document.getElementById('canvas-container');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const dinoImage = new Image();
        dinoImage.src = 'dino.png';

        // --- 遊戲變數 ---
        let dino, gravity = 0.6, gameSpeed = 5, score = 0;
        let obstacles = [], fireballs = [], creatures = [], scorePopups = [], flyingEnemies = [], enemyBullets = [];
        let ultimateFireball = null;
        let gameOver = false, gameStarted = false, frameCount = 0;
        let nextObstacleFrame, nextCreatureFrame, nextFlyingEnemySpawn = 0;
        const keyState = {};
        let xPressStartTime = 0; // 新增變數，記錄X鍵按下的時間

        // 資源管理
        let maxFireballs = 10, currentFireballs = 10, fireballRegenRate = 120, fireballRegenCounter = 0;
        let maxHealth = 3, dinoHealth = 3, isInvincible = false, invincibilityDuration = 120, invincibilityCounter = 0;
        let isCharging = false, chargeTime = 0, minChargeTime = 30;

        // 日夜循環
        let timeInCycle = 0, transitionTime = 0, isDay = true;
        const dayDuration = 15 * 60, nightDuration = 30 * 60, transitionDuration = 60;
        const dayColors = { bg: '#ffffff', fg: '#555', ground: '#333' }, nightColors = { bg: '#2c3e50', fg: '#ecf0f1', ground: '#bdc3c7' };
        let currentColors = { ...dayColors };

        function setNextObstacleFrame() { nextObstacleFrame = frameCount + Math.floor(Math.random() * 50 + 60); }
        function setNextCreatureFrame() { nextCreatureFrame = frameCount + Math.floor(Math.random() * 150 + 120); }

        // --- 類別定義 ---
        class ScorePopup{constructor(x,y,t){this.x=x;this.y=y;this.text=t;this.life=60;this.opacity=1;}update(){this.y-=0.5;this.life--;this.opacity=this.life/60;}draw(){ctx.save();ctx.globalAlpha=this.opacity;ctx.fillStyle='#28a745';ctx.font='16px Arial';ctx.fillText(this.text,this.x,this.y);ctx.restore();}}
        class Fireball{constructor(x,y){this.x=x;this.y=y;this.width=20;this.height=10;this.speed=10;}draw(){ctx.fillStyle='#ff4500';ctx.fillRect(this.x,this.y,this.width,this.height);}update(){this.x+=this.speed;this.draw();}}
        class UltimateFireball{constructor(x,y){this.x=x;this.y=y;this.w=50;this.h=canvas.height;this.speed=gameSpeed*2;}draw(){const grad=ctx.createLinearGradient(this.x,this.y,this.x+this.w,this.y);grad.addColorStop(0,'rgba(255,100,0,0.8)');grad.addColorStop(0.5,'rgba(255,255,0,0.8)');grad.addColorStop(1,'rgba(255,100,0,0.8)');ctx.fillStyle=grad;ctx.fillRect(this.x,this.y,this.w,this.h);}update(){this.x+=this.speed;this.draw();}}
        class Dino{
            constructor(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;this.dy=0;this.vx=0;this.moveSpeed=5;this.isJumping=false;this.jumpPower=-15;this.groundY=canvas.height-10;}
            draw(){if(isInvincible){if(invincibilityCounter%10<5){ctx.drawImage(dinoImage,this.x,this.y,this.w,this.h);}}else{ctx.drawImage(dinoImage,this.x,this.y,this.w,this.h);}}
            update(){
                this.handleMovement();
                this.x += this.vx;
                if(this.isJumping){this.dy+=gravity;this.y+=this.dy;}
                if(this.y+this.h>this.groundY){this.y=this.groundY-this.h;this.dy=0;this.isJumping=false;}
                if(this.x<0){this.x=0;}//左邊界
                if(this.x+this.w>canvas.width){this.x=canvas.width-this.w;}//右邊界
                this.draw();
            }
            handleMovement(){
                this.vx = 0;
                if(keyState['KeyZ']){ this.vx = -this.moveSpeed; }
                if(keyState['KeyC']){ this.vx = this.moveSpeed; }
            }
            jump(){if(!this.isJumping){this.isJumping=true;this.dy=this.jumpPower;}}
            cutJump() { if (this.dy < 0) { this.dy = 0; } }
            shoot(){if(currentFireballs>0){fireballs.push(new Fireball(this.x+this.w,this.y+this.h/2-5));currentFireballs--;}}
            fireUltimate(){if(chargeTime>=minChargeTime){ultimateFireball=new UltimateFireball(this.x+this.w,0);currentFireballs=0;}}
        }
        class Obstacle{constructor(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;}draw(){ctx.fillStyle='#d9534f';ctx.fillRect(this.x,this.y,this.w,this.h);}update(){this.x-=gameSpeed;this.draw();}}
        class Creature{constructor(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;this.dx=-gameSpeed*0.7;this.dy=0;this.isJumping=false;this.jumpPower=-12;this.groundY=canvas.height-10;}draw(){ctx.fillStyle='#8a2be2';ctx.fillRect(this.x,this.y,this.w,this.h);}update(){this.x+=this.dx;if(this.isJumping){this.dy+=gravity;this.y+=this.dy;}if(this.y+this.h>this.groundY){this.y=this.groundY-this.h;this.dy=0;this.isJumping=false;}for(const o of obstacles){if(o.x-this.x<80&&o.x-this.x>0&&!this.isJumping){this.jump();break;}}this.draw();}jump(){if(!this.isJumping){this.isJumping=true;this.dy=this.jumpPower;}}}
        class EnemyBullet{constructor(x,y){this.x=x;this.y=y;this.w=4;this.h=10;this.speed=4;}draw(){ctx.fillStyle='#ffeb3b';ctx.fillRect(this.x,this.y,this.w,this.h);}update(){this.y+=this.speed;this.draw();}}
        class FlyingEnemy{constructor(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;this.dx=-gameSpeed*0.5;this.dy=1;this.targetY=Math.random()*60+20;this.isDescending=true;this.shootTimer=0;this.shootDelay=30;}draw(){ctx.fillStyle='#f1c40f';ctx.fillRect(this.x,this.y,this.w,this.h);}update(){if(this.isDescending){this.y+=this.dy;if(this.y>=this.targetY){this.isDescending=false;}}this.x+=this.dx;if(!this.isDescending){this.shootTimer++;if(this.shootTimer>=this.shootDelay){this.shoot();this.shootTimer=0;}}this.draw();}shoot(){enemyBullets.push(new EnemyBullet(this.x+this.w/2,this.y+this.h));}}

        // --- 遊戲邏輯處理 ---
        function handleDamage(){
            console.log("Dino took damage! Current health:", dinoHealth);
            if(isInvincible) return;
            dinoHealth--;
            isInvincible = true;
            invincibilityCounter = 0;
            canvasContainer.classList.add('shake');
            setTimeout(() => canvasContainer.classList.remove('shake'), 500);
            if(dinoHealth <= 0){
                gameOver = true;
                console.log("Dino health reached 0. Game Over!");
            }
        }
        function lerpColor(a,b,am){const ar=a>>16,ag=a>>8&0xff,ab=a&0xff,br=b>>16,bg=b>>8&0xff,bb=b&0xff,rr=ar+am*(br-ar),rg=ag+am*(bg-ag),rb=ab+am*(bb-ab);return(rr<<16|rg<<8|rb|0).toString(16).padStart(6,'0').replace(/^/,'#');}
        function handleDayNightCycle(){
            timeInCycle++;
            let dur = isDay ? dayDuration : nightDuration;
            if (timeInCycle > dur) {
                if (transitionTime < transitionDuration) {
                    transitionTime++;
                    const sC=isDay?dayColors:nightColors,eC=isDay?nightColors:dayColors,f=transitionTime/transitionDuration;
                    currentColors.bg=lerpColor(parseInt(sC.bg.slice(1),16),parseInt(eC.bg.slice(1),16),f);
                    currentColors.fg=lerpColor(parseInt(sC.fg.slice(1),16),parseInt(eC.fg.slice(1),16),f);
                    currentColors.ground=lerpColor(parseInt(sC.ground.slice(1),16),parseInt(eC.ground.slice(1),16),f);
                } else {
                    isDay = !isDay;
                    timeInCycle = 0;
                    transitionTime = 0;
                }
            }
            document.body.style.backgroundColor = currentColors.bg;
            document.querySelector('h1').style.color = currentColors.fg;
            document.querySelector('p').style.color = currentColors.fg;
            canvas.style.borderColor = currentColors.ground;
        }
        function handleInvincibility(){if(isInvincible){invincibilityCounter++;if(invincibilityCounter>=invincibilityDuration){isInvincible=false;invincibilityCounter=0;}}}
        function handleFireballs(){for(let i=fireballs.length-1;i>=0;i--){fireballs[i].update();for(let j=creatures.length-1;j>=0;j--){if(fireballs[i]&&fireballs[i].x<creatures[j].x+creatures[j].w&&fireballs[i].x+fireballs[i].width>creatures[j].x&&fireballs[i].y<creatures[j].y+creatures[j].h&&fireballs[i].y+fireballs[i].height>creatures[j].y){const c=creatures[j];scorePopups.push(new ScorePopup(c.x,c.y,'+100'));creatures.splice(j,1);fireballs.splice(i,1);score+=100;break;}}for(let k=flyingEnemies.length-1;k>=0;k--){if(fireballs[i]&&fireballs[i].x<flyingEnemies[k].x+flyingEnemies[k].w&&fireballs[i].x+fireballs[i].width>flyingEnemies[k].x&&fireballs[i].y<flyingEnemies[k].y+flyingEnemies[k].h&&fireballs[i].y+fireballs[i].height>flyingEnemies[k].y){const fe=flyingEnemies[k];scorePopups.push(new ScorePopup(fe.x,fe.y,'+150'));flyingEnemies.splice(k,1);fireballs.splice(i,1);score+=150;break;}}if(fireballs[i]&&fireballs[i].x>canvas.width){fireballs.splice(i,1);}}}
        function handleUltimateFireball(){if(!ultimateFireball)return;ultimateFireball.update();const uf=ultimateFireball;[obstacles,creatures,flyingEnemies,enemyBullets].forEach(arr=>{for(let i=arr.length-1;i>=0;i--){const item=arr[i];if(uf.x<item.x+item.w&&uf.x+uf.w>item.x&&uf.y<item.y+item.h&&uf.y+uf.h>item.y){arr.splice(i,1);}}});if(uf.x>canvas.width){ultimateFireball=null;}}
        function handleScorePopups(){for(let i=scorePopups.length-1;i>=0;i--){scorePopups[i].update();scorePopups[i].draw();if(scorePopups[i].life<=0){scorePopups.splice(i,1);}}}
        function handleFireballRegen(){if(currentFireballs<maxFireballs){fireballRegenCounter++;if(fireballRegenCounter>=fireballRegenRate){currentFireballs++;fireballRegenCounter=0;}}}
        function handleObstacles(){if(frameCount>nextObstacleFrame){createObstacle();setNextObstacleFrame();}for(let i=obstacles.length-1;i>=0;i--){obstacles[i].update();if(dino.x<obstacles[i].x+obstacles[i].w&&dino.x+dino.w>obstacles[i].x&&dino.y<obstacles[i].y+obstacles[i].h&&dino.y+dino.h>obstacles[i].y){handleDamage();obstacles.splice(i,1);}}}
        function handleCreatures(){if(frameCount>nextCreatureFrame){createCreature();setNextCreatureFrame();}for(let i=creatures.length-1;i>=0;i--){creatures[i].update();if(dino.x<creatures[i].x+creatures[i].w&&dino.x+dino.w>creatures[i].x&&dino.y<creatures[i].y+creatures[i].h&&dino.y+dino.h>creatures[i].y){handleDamage();creatures.splice(i,1);}}}
        function handleFlyingEnemies(){
            if (!isDay && frameCount > nextFlyingEnemySpawn) {
                createFlyingEnemy();
                nextFlyingEnemySpawn = frameCount + Math.floor(Math.random() * 120 + 100);
            }
            for(let i=flyingEnemies.length-1;i>=0;i--){flyingEnemies[i].update();if(dino.x<flyingEnemies[i].x+flyingEnemies[i].w&&dino.x+dino.w>flyingEnemies[i].x&&dino.y<flyingEnemies[i].y+flyingEnemies[i].h&&dino.y+dino.h>flyingEnemies[i].y){handleDamage();flyingEnemies.splice(i,1);}if(flyingEnemies[i]&&flyingEnemies[i].x+flyingEnemies[i].w<0){flyingEnemies.splice(i,1);}}}
        function handleEnemyBullets(){for(let i=enemyBullets.length-1;i>=0;i--){enemyBullets[i].update();if(dino.x<enemyBullets[i].x+enemyBullets[i].w&&dino.x+dino.w>enemyBullets[i].x&&dino.y<enemyBullets[i].y+enemyBullets[i].h&&dino.y+dino.h>enemyBullets[i].y){handleDamage();enemyBullets.splice(i,1);}if(enemyBullets[i]&&enemyBullets[i].y>canvas.height){enemyBullets.splice(i,1);}}}
        function createObstacle(){const h=Math.random()*30+20;obstacles.push(new Obstacle(canvas.width,canvas.height-h-10,20,h));}
        function createCreature(){const s=30;creatures.push(new Creature(canvas.width,canvas.height-s-10,s,s));}
        function createFlyingEnemy(){const s=35;flyingEnemies.push(new FlyingEnemy(canvas.width,-s,s,20));}

        // --- 繪圖與主迴圈 ---
        function drawChargeIndicator(){
            // 如果X鍵沒有被按下，或者火球能量不滿，或者沒有記錄按下時間，則不顯示蓄力條
            if (!keyState['KeyX'] || currentFireballs !== maxFireballs || xPressStartTime === 0) {
                return;
            }

            const barW=dino.w,barH=5,x=dino.x,y=dino.y-10;
            
            // 根據X鍵按下的時間來計算當前蓄力進度
            const currentChargeProgress = frameCount - xPressStartTime;
            const fillW=(currentChargeProgress/minChargeTime)*barW;

            ctx.fillStyle='#00bfff';
            ctx.fillRect(x,y,Math.min(fillW,barW),barH);
        }
        function drawHealth(){ctx.fillStyle='#d9534f';ctx.font='24px Arial';let hStr='';for(let i=0;i<dinoHealth;i++){hStr+='♥';}ctx.textAlign='right';ctx.fillText(hStr,canvas.width-10,30);ctx.textAlign='left';}
        function drawInfo(){ctx.fillStyle=currentColors.fg;ctx.font='20px Arial';ctx.fillText(`分數: ${score}`,10,30);}
        function drawFireballBar(){const bW=150,bH=15,x=10,y=40;ctx.strokeStyle=currentColors.ground;ctx.strokeRect(x,y,bW,bH);const fillW=(currentFireballs/maxFireballs)*bW;ctx.fillStyle='#ff8c00';ctx.fillRect(x,y,fillW,bH);ctx.fillStyle=currentColors.bg;ctx.font='12px Arial';ctx.textAlign='center';ctx.fillText(`${currentFireballs}/${maxFireballs}`,x+bW/2,y+bH-3);ctx.textAlign='left';}
        function drawGround(){ctx.beginPath();ctx.moveTo(0,canvas.height-10);ctx.lineTo(canvas.width,canvas.height-10);ctx.strokeStyle=currentColors.ground;ctx.lineWidth=2;ctx.stroke();}

        function animate(){
            console.log("animate loop running. gameOver:", gameOver, "dinoHealth:", dinoHealth, "frameCount:", frameCount);
            if(gameOver){
                console.log("Game Over detected. Stopping animation.");
                showGameOver();
                window.addEventListener('keydown',resetOnGameOver,{once:true});
                return;
            }
            requestAnimationFrame(animate);
            if (keyState['KeyX'] && currentFireballs === maxFireballs && !isCharging && xPressStartTime > 0) {
                // 如果X鍵被按住，火球已滿，尚未蓄力，且按下時間已記錄
                if (frameCount - xPressStartTime >= minChargeTime) {
                    isCharging = true; // 開始蓄力
                    chargeTime = frameCount - xPressStartTime; // 初始化蓄力時間
                }
            }
            if(isCharging){
                chargeTime++;
                console.log("Charging: chargeTime =", chargeTime);
            }
            ctx.clearRect(0,0,canvas.width,canvas.height);
            handleDayNightCycle();
            handleInvincibility();
            drawGround();
            dino.update();
            handleFireballs();
            handleUltimateFireball();
            handleObstacles();
            handleCreatures();
            handleFlyingEnemies();
            handleEnemyBullets();
            handleFireballRegen();
            handleScorePopups();
            drawInfo();
            drawFireballBar();
            drawHealth();
            drawChargeIndicator();
            score++;
            frameCount++;
            if(frameCount%200===0){gameSpeed+=0.2;}
        }

        // --- 遊戲狀態 ---
        function resetGame(){
            console.log("Resetting game...");
            dino=new Dino(50,canvas.height-50,40,40);
            obstacles=[];fireballs=[];creatures=[];scorePopups=[];flyingEnemies=[];enemyBullets=[];ultimateFireball=null;
            score=0;gameSpeed=5;gameOver=false;gameStarted=true;frameCount=0;
            currentFireballs=maxFireballs;fireballRegenCounter=0;
            dinoHealth=maxHealth;isInvincible=false;invincibilityCounter=0;
            isCharging=false;chargeTime=0;
            isDay=true;timeInCycle=0;transitionTime=0;currentColors={...dayColors};
            nextFlyingEnemySpawn = 0;
            setNextObstacleFrame();
            setNextCreatureFrame();
            animate();
            console.log("Game reset complete. Starting animation.");
        }

        function showGameOver(){ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='white';ctx.font='40px Arial';ctx.textAlign='center';ctx.fillText('遊戲結束',canvas.width/2,canvas.height/2-20);ctx.font='20px Arial';ctx.fillText(`你的分數: ${score}`,canvas.width/2,canvas.height/2+20);ctx.fillText('按任意鍵重新開始',canvas.width/2,canvas.height/2+60);ctx.textAlign='left';}
        function showStartScreen(){ctx.clearRect(0,0,canvas.width,canvas.height);drawGround();dino.draw();drawFireballBar();drawHealth();ctx.fillStyle=currentColors.fg;ctx.font='30px Arial';ctx.textAlign='center';ctx.fillText('準備好了嗎?',canvas.width/2,canvas.height/2-20);ctx.textAlign='left';}
        
        // --- 事件監聽 ---
        window.addEventListener('keydown', (e) => {
            const k = e.code;
            keyState[k] = true;
            if (k === 'Space' || k === 'ArrowUp') {
                e.preventDefault();
                if (!gameStarted) resetGame();
                else if (!gameOver) dino.jump();
            } else if (k === 'KeyX') {
                if (gameStarted && !gameOver) {
                    if (currentFireballs === maxFireballs) {
                        // 如果火球已滿，記錄按下時間，不立即射擊或蓄力
                        if (xPressStartTime === 0) { // 避免重複記錄
                            xPressStartTime = frameCount;
                        }
                    } else {
                        // 如果火球未滿，立即發射普通子彈
                        dino.shoot();
                    }
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            const k = e.code;
            keyState[k] = false;
            if (k === 'Space' || k === 'ArrowUp') {
                if (gameStarted && !gameOver) dino.cutJump();
            }
            if (k === 'KeyX') {
                if (isCharging) {
                    dino.fireUltimate();
                    isCharging = false;
                    chargeTime = 0;
                } else if (xPressStartTime > 0 && currentFireballs === maxFireballs) {
                    // 如果是短按（不足以觸發蓄力），且火球已滿，則發射普通子彈
                    dino.shoot();
                }
                xPressStartTime = 0; // 重置 xPressStartTime
            }
        });

        function resetOnGameOver(e){if(gameOver)resetGame();}

        dinoImage.onload=()=>{dino=new Dino(50,canvas.height-50,40,40);showStartScreen();};
    </script>

</body>
</html>