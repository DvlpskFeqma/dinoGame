<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>純HTML小恐龍遊戲</title>
    <style>
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f7f7f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        h1 { color: #555; }
        canvas { border: 2px solid #333; background-color: #fff; }
        p { color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>小恐龍遊戲</h1>
    <canvas id="gameCanvas" width="800" height="250"></canvas>
    <p>按<strong>空白鍵</strong>或<strong>向上箭頭</strong>跳躍 | 按 <strong>X</strong> 發射火球</p>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const dinoImage = new Image();
        dinoImage.src = 'dino.png';

        // --- 遊戲變數 ---
        let dino;
        let gravity = 0.6;
        let obstacles = [], fireballs = [], creatures = [], scorePopups = [];
        let gameSpeed = 5, score = 0;
        let gameOver = false, gameStarted = false;
        let frameCount = 0;
        let nextObstacleFrame, nextCreatureFrame;

        // 火球資源管理
        let maxFireballs = 10, currentFireballs = 10;
        let fireballRegenRate = 120, fireballRegenCounter = 0;

        function setNextObstacleFrame() { nextObstacleFrame = frameCount + Math.floor(Math.random() * 50 + 60); }
        function setNextCreatureFrame() { nextCreatureFrame = frameCount + Math.floor(Math.random() * 150 + 120); }

        // --- 類別定義 ---
        class ScorePopup {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.life = 60; // 持續60幀
                this.opacity = 1;
            }
            update() {
                this.y -= 0.5; // 向上飄
                this.life--;
                this.opacity = this.life / 60;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = '#28a745'; // 綠色
                ctx.font = '16px Arial';
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        class Fireball {
            constructor(x, y) { this.x = x; this.y = y; this.width = 20; this.height = 10; this.speed = 10; }
            draw() { ctx.fillStyle = '#ff4500'; ctx.fillRect(this.x, this.y, this.width, this.height); }
            update() { this.x += this.speed; this.draw(); }
        }

        class Dino {
            constructor(x, y, w, h) {
                this.x = x; this.y = y; this.w = w; this.h = h;
                this.dy = 0; this.isJumping = false;
                this.jumpPower = -15; this.groundY = canvas.height - 10;
            }
            draw() { ctx.drawImage(dinoImage, this.x, this.y, this.w, this.h); }
            update() {
                if (this.isJumping) { this.dy += gravity; this.y += this.dy; }
                if (this.y + this.h > this.groundY) { this.y = this.groundY - this.h; this.dy = 0; this.isJumping = false; }
                this.draw();
            }
            jump() { if (!this.isJumping) { this.isJumping = true; this.dy = this.jumpPower; } }
            shoot() {
                if (currentFireballs > 0) {
                    fireballs.push(new Fireball(this.x + this.w, this.y + this.h / 2 - 5));
                    currentFireballs--;
                }
            }
        }

        class Obstacle {
            constructor(x, y, w, h) { this.x = x; this.y = y; this.w = w; this.h = h; }
            draw() { ctx.fillStyle = '#d9534f'; ctx.fillRect(this.x, this.y, this.w, this.h); }
            update() { this.x -= gameSpeed; this.draw(); }
        }

        class Creature {
            constructor(x, y, w, h) {
                this.x = x; this.y = y; this.w = w; this.h = h;
                this.dx = -gameSpeed * 0.7; this.dy = 0; this.isJumping = false;
                this.jumpPower = -12; this.groundY = canvas.height - 10;
            }
            draw() { ctx.fillStyle = '#8a2be2'; ctx.fillRect(this.x, this.y, this.w, this.h); }
            update() {
                this.x += this.dx;
                if (this.isJumping) { this.dy += gravity; this.y += this.dy; }
                if (this.y + this.h > this.groundY) { this.y = this.groundY - this.h; this.dy = 0; this.isJumping = false; }
                for (const obs of obstacles) {
                    if (obs.x - this.x < 80 && obs.x - this.x > 0 && !this.isJumping) { this.jump(); break; }
                }
                this.draw();
            }
            jump() { if (!this.isJumping) { this.isJumping = true; this.dy = this.jumpPower; } }
        }

        // --- 遊戲邏輯處理 ---
        function handleFireballs() {
            for (let i = fireballs.length - 1; i >= 0; i--) {
                fireballs[i].update();
                for (let j = creatures.length - 1; j >= 0; j--) {
                    if (fireballs[i] && fireballs[i].x < creatures[j].x + creatures[j].w && fireballs[i].x + fireballs[i].width > creatures[j].x && fireballs[i].y < creatures[j].y + creatures[j].h && fireballs[i].y + fireballs[i].height > creatures[j].y) {
                        const creature = creatures[j];
                        scorePopups.push(new ScorePopup(creature.x, creature.y, '+100'));
                        creatures.splice(j, 1); 
                        fireballs.splice(i, 1); 
                        score += 100; 
                        break;
                    }
                }
                if (fireballs[i] && fireballs[i].x > canvas.width) { fireballs.splice(i, 1); }
            }
        }

        function handleScorePopups() {
            for (let i = scorePopups.length - 1; i >= 0; i--) {
                scorePopups[i].update();
                scorePopups[i].draw();
                if (scorePopups[i].life <= 0) {
                    scorePopups.splice(i, 1);
                }
            }
        }

        function handleFireballRegen() { if (currentFireballs < maxFireballs) { fireballRegenCounter++; if (fireballRegenCounter >= fireballRegenRate) { currentFireballs++; fireballRegenCounter = 0; } } }
        function handleObstacles() { if (frameCount === nextObstacleFrame) { createObstacle(); setNextObstacleFrame(); } for (let i = obstacles.length - 1; i >= 0; i--) { obstacles[i].update(); if (dino.x < obstacles[i].x + obstacles[i].w && dino.x + dino.w > obstacles[i].x && dino.y < obstacles[i].y + obstacles[i].h && dino.y + dino.h > obstacles[i].y) { gameOver = true; } if (obstacles[i].x + obstacles[i].w < 0) { obstacles.splice(i, 1); } } }
        function handleCreatures() { if (frameCount === nextCreatureFrame) { createCreature(); setNextCreatureFrame(); } for (let i = creatures.length - 1; i >= 0; i--) { creatures[i].update(); if (dino.x < creatures[i].x + creatures[i].w && dino.x + dino.w > creatures[i].x && dino.y < creatures[i].y + creatures[i].h && dino.y + dino.h > creatures[i].y) { gameOver = true; } if (creatures[i].x + creatures[i].w < 0) { creatures.splice(i, 1); } } }
        function createObstacle() { const h = Math.random() * 30 + 20; obstacles.push(new Obstacle(canvas.width, canvas.height - h - 10, 20, h)); }
        function createCreature() { const size = 30; creatures.push(new Creature(canvas.width, canvas.height - size - 10, size, size)); }

        // --- 繪圖與主迴圈 ---
        function drawInfo() { ctx.fillStyle = '#555'; ctx.font = '20px Arial'; ctx.fillText(`分數: ${score}`, 10, 30); }
        function drawFireballBar() { const barWidth = 150, barHeight = 15, x = 10, y = 40; ctx.strokeStyle = '#555'; ctx.strokeRect(x, y, barWidth, barHeight); const fillWidth = (currentFireballs / maxFireballs) * barWidth; ctx.fillStyle = '#ff8c00'; ctx.fillRect(x, y, fillWidth, barHeight); ctx.fillStyle = '#fff'; ctx.font = '12px Arial'; ctx.textAlign = 'center'; ctx.fillText(`${currentFireballs} / ${maxFireballs}`, x + barWidth / 2, y + barHeight - 3); ctx.textAlign = 'left'; }
        function drawGround() { ctx.beginPath(); ctx.moveTo(0, canvas.height - 10); ctx.lineTo(canvas.width, canvas.height - 10); ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.stroke(); }

        function animate() {
            if (gameOver) { showGameOver(); window.addEventListener('keydown', resetOnGameOver, { once: true }); return; }
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGround();
            dino.update();
            handleFireballs();
            handleObstacles();
            handleCreatures();
            handleFireballRegen();
            handleScorePopups();
            drawInfo();
            drawFireballBar();
            score++;
            frameCount++;
            if (frameCount % 200 === 0) { gameSpeed += 0.2; }
        }

        // --- 遊戲狀態 ---
        function resetGame() {
            dino = new Dino(50, canvas.height - 50, 40, 40);
            obstacles = []; fireballs = []; creatures = []; scorePopups = [];
            score = 0; gameSpeed = 5; gameOver = false; gameStarted = true; frameCount = 0;
            currentFireballs = maxFireballs; fireballRegenCounter = 0;
            setNextObstacleFrame();
            setNextCreatureFrame();
            animate();
        }

        function showGameOver() { ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = 'white'; ctx.font = '40px Arial'; ctx.textAlign = 'center'; ctx.fillText('遊戲結束', canvas.width / 2, canvas.height / 2 - 20); ctx.font = '20px Arial'; ctx.fillText(`你的分數: ${score}`, canvas.width / 2, canvas.height / 2 + 20); ctx.fillText('按任意鍵重新開始', canvas.width / 2, canvas.height / 2 + 60); ctx.textAlign = 'left'; }
        function showStartScreen() { ctx.clearRect(0, 0, canvas.width, canvas.height); drawGround(); dino.draw(); drawFireballBar(); ctx.fillStyle = '#555'; ctx.font = '30px Arial'; ctx.textAlign = 'center'; ctx.fillText('準備好了嗎?', canvas.width / 2, canvas.height / 2 - 20); ctx.textAlign = 'left'; }
        
        // --- 事件監聽 ---
        function handleControls(e) { const key = e.code; if (key === 'Space' || key === 'ArrowUp') { e.preventDefault(); if (!gameStarted) resetGame(); else if (!gameOver) dino.jump(); } else if (key === 'KeyX') { if (gameStarted && !gameOver) dino.shoot(); } }
        function resetOnGameOver(e) { if (gameOver) resetGame(); }

        window.addEventListener('keydown', handleControls);

        dinoImage.onload = () => { dino = new Dino(50, canvas.height - 50, 40, 40); showStartScreen(); };
    </script>

</body>
</html>